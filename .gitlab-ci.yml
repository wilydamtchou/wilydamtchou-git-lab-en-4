# ============================================================================
# GitLab CI/CD Pipeline
# CI actif — Deploy / Release / Maintenance désactivés via variable
# ============================================================================

stages:
  - build
  - test
  - deploy-dev
  - deploy-qa
  - release
  - maintenance

variables:
  MAVEN_OPTS: "-Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=5"
  MAVEN_CLI_OPTS: "-B ${MAVEN_OPTS}"

# ============================================================================
# CI FLOW — BUILD
# ============================================================================

build:
  stage: build
  image: maven:3.9.0-eclipse-temurin-17
  script:
    - mvn ${MAVEN_CLI_OPTS} verify
  artifacts:
    paths:
      - target/
    expire_in: 1 day
  cache:
    paths:
      - .m2/repository/
  interruptible: true

# ============================================================================
# TEST — CUCUMBER
# ============================================================================

cucumber:
  stage: test
  image: maven:3.9.0-eclipse-temurin-17
  needs: [build]
  script:
    - mvn ${MAVEN_CLI_OPTS} test -Dcucumber.options="--plugin json:target/cucumber.json"
  artifacts:
    paths:
      - target/cucumber.json
    expire_in: 1 day
  cache:
    paths:
      - .m2/repository/
  interruptible: true

# ============================================================================
# TEST — NEWMAN (non bloquant)
# ============================================================================

newman:
  stage: test
  image: maven:3.9.0-eclipse-temurin-17
  needs: [build]
  allow_failure: true
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - npm install -g newman
  script:
    - mvn ${MAVEN_CLI_OPTS} clean package -DskipTests
    - java -jar target/demo-pipeline-0.0.1-SNAPSHOT.jar &
    - sleep 10
    - newman run postman/api-tests.json
  artifacts:
    paths:
      - target/demo-pipeline-0.0.1-SNAPSHOT.jar
    expire_in: 1 day
  cache:
    paths:
      - .m2/repository/
  interruptible: true