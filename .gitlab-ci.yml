# Project 4 GitLab CI pipeline

stages:
  - build
  - test
  - deploy
  - release
  - maintenance

# Configurations par d√©faut
default:
  interruptible: true
  retry: 1
  image: maven:3.9-eclipse-temurin-17  # Maven + Java 17
  before_script:
    - echo "Starting job $CI_JOB_NAME"

# Build
build:
  stage: build
  script:
    - mvn -B package
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Cucumber Tests
cucumber:
  stage: test
  needs: ["build"]
  script:
    - mvn -B test -Dcucumber.options="--plugin json:target/cucumber.json"
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Newman Tests
newman:
  stage: test
  needs: ["build"]
  script:
    - newman run tests/postman_collection.json
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Deploy DEV
deploy_dev:
  stage: deploy
  needs: ["build", "cucumber", "newman"]
  only:
    - develop
  script:
    - ./scripts/deploy-dev.sh

# Deploy QA
deploy_qa:
  stage: deploy
  needs: ["build", "cucumber", "newman"]
  only:
    - main
  script:
    - ./scripts/deploy-qa.sh

# Release
release:
  stage: release
  only:
    - main
  script:
    - mvn versions:set -DnewVersion=$(date +%Y.%m.%d)
    - git tag v$(date +%Y.%m.%d)
    - git push origin --tags

# Maintenance (scheduled)
maintenance:
  stage: maintenance
  only:
    - schedules
  script:
    - ./scripts/cleanup.sh