# ============================================================================
# GitLab CI/CD Pipeline
# CI actif â€” Deploy / Release / Maintenance dÃ©sactivÃ©s via variable
# ============================================================================

stages:
  - build
  - test
  - deploy-dev
  - deploy-qa
  - release
  - maintenance

variables:
  MAVEN_OPTS: "-Dmaven.wagon.http.retryHandler.class=standard -Dmaven.wagon.http.retryHandler.count=5"
  MAVEN_CLI_OPTS: "-B ${MAVEN_OPTS}"
  DOCKER_HOST: "unix:///var/run/docker.sock"
  DISABLE_DEPLOY: "true"   # ðŸ”´ switch global pour bloquer tous les dÃ©ploiements

# ============================================================================
# CI FLOW â€” BUILD
# ============================================================================

build:
  stage: build
  image: maven:3.9.0-eclipse-temurin-17
  script:
    - mvn ${MAVEN_CLI_OPTS} verify
  artifacts:
    paths:
      - target/
    expire_in: 1 day
  cache:
    paths:
      - .m2/repository/
  tags:
    - self-hosted
  interruptible: true

# ============================================================================
# TEST â€” CUCUMBER
# ============================================================================

cucumber:
  stage: test
  image: maven:3.9.0-eclipse-temurin-17
  needs: [build]
  script:
    - mvn ${MAVEN_CLI_OPTS} test -Dcucumber.options="--plugin json:target/cucumber.json"
  artifacts:
    paths:
      - target/cucumber.json
    expire_in: 1 day
  cache:
    paths:
      - .m2/repository/
  tags:
    - self-hosted
  interruptible: true

# ============================================================================
# TEST â€” NEWMAN (non bloquant)
# ============================================================================

newman:
  stage: test
  image: maven:3.9.0-eclipse-temurin-17
  needs: [build]
  allow_failure: true
  before_script:
    - apt-get update && apt-get install -y nodejs npm curl
    - npm install -g newman
  script:
    - mvn ${MAVEN_CLI_OPTS} clean package -DskipTests
    - java -jar target/demo-pipeline-0.0.1-SNAPSHOT.jar &
    - sleep 10
    - newman run postman/api-tests.json
  artifacts:
    paths:
      - target/demo-pipeline-0.0.1-SNAPSHOT.jar
    expire_in: 1 day
  cache:
    paths:
      - .m2/repository/
  tags:
    - self-hosted
  interruptible: true

# ============================================================================
# DEPLOY QA â€” DÃ‰SACTIVÃ‰
# ============================================================================

deploy_qa:
  stage: deploy-qa
  image: ubuntu:latest
  needs: [build, cucumber, newman]
  rules:
    - if: '$DISABLE_DEPLOY == "true"'
      when: never
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  script:
    - bash ./scripts/deploy-qa.sh
  tags:
    - self-hosted
  interruptible: false

deploy_dev_manual:
  stage: deploy-dev
  image: ubuntu:latest
  needs: [build, cucumber, newman]
  rules:
    - if: '$DISABLE_DEPLOY == "true"'
      when: never
    - when: manual
  script:
    - bash ./scripts/deploy-dev.sh
  tags:
    - self-hosted
  interruptible: false

# ============================================================================
# DEPLOY QA â€” DÃ‰SACTIVÃ‰
# ============================================================================

deploy_qa:
  stage: deploy-qa
  image: ubuntu:latest
  needs: [build, cucumber, newman]
  rules:
    - if: '$DISABLE_DEPLOY == "true"'
      when: never
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  script:
    - bash ./scripts/deploy-qa.sh
  tags:
    - self-hosted
  interruptible: false

# ============================================================================
# RELEASE â€” DÃ‰SACTIVÃ‰
# ============================================================================

release:
  stage: release
  image: ubuntu:latest
  rules:
    - if: '$DISABLE_DEPLOY == "true"'
      when: never
    - when: manual
  before_script:
    - apt-get update && apt-get install -y git
  script:
    - git config --global user.name "gitlab-runner"
    - git config --global user.email "gitlab-runner@gitlab.local"
    - VERSION=$(date +%Y.%m.%d)
    - TAG=v${VERSION}-$(date +%H%M%S)
    - echo "Creating tag: $TAG"
    - git tag $TAG
    - echo "Pushing tag: $TAG"
    - git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git $TAG
    - echo "âœ… Tag $TAG created and pushed successfully"
  tags:
    - self-hosted
  interruptible: false

# ============================================================================
# MAINTENANCE â€” DÃ‰SACTIVÃ‰
# ============================================================================

maintenance:
  stage: maintenance
  image: ubuntu:latest
  rules:
    - if: '$DISABLE_DEPLOY == "true"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
  script:
    - ./scripts/cleanup.sh
  tags:
    - self-hosted
  interruptible: true

maintenance_manual:
  stage: maintenance
  image: ubuntu:latest
  rules:
    - if: '$DISABLE_DEPLOY == "true"'
      when: never
    - when: manual
  script:
    - ./scripts/cleanup.sh
  tags:
    - self-hosted
  interruptible: true