stages:
  - build
  - test
  - deploy
  - maintenance

default:
  interruptible: true
  retry: 1
  allow_failure: false

build:
  stage: build
  script:
    - mvn -B package
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

cucumber:
  stage: test
  needs: ["build"]
  script:
    - mvn -B test -Dcucumber.options="--plugin json:target/cucumber.json"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

newman:
  stage: test
  needs: ["build"]
  script:
    - newman run tests/postman_collection.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

deploy_dev:
  stage: deploy
  needs: ["build", "cucumber", "newman"]
  only:
    - develop
  script:
    - ./scripts/deploy-dev.sh

deploy_qa:
  stage: deploy
  needs: ["build", "cucumber", "newman"]
  only:
    - main
  script:
    - ./scripts/deploy-qa.sh

release:
  stage: release
  only:
    - main
  script:
    - mvn versions:set -DnewVersion=$(date +%Y.%m.%d)
    - git tag v$(date +%Y.%m.%d)

maintenance:
  stage: maintenance
  only:
    - schedules
  script:
    - ./scripts/cleanup.sh
