stages:
  - build
  - test
  - deploy
  - release
  - maintenance

default:
  interruptible: true
  retry: 1
  image: maven:3.9-eclipse-temurin-17
  before_script:
    - echo "Starting job $CI_JOB_NAME"

# Build
build:
  stage: build
  script:
    - mvn -B package
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"

# Cucumber Tests (obligatoires)
cucumber:
  stage: test
  needs: ["build"]
  script:
    - mvn -B test -Dcucumber.options="--plugin json:target/cucumber.json"
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"

# Newman Tests (optionnels)
newman:
  stage: test
  needs: ["build"]
  script:
    - newman run tests/postman_collection.json
  allow_failure: true   # ✅ Newman optionnel
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"

# Deploy DEV
deploy_dev:
  stage: deploy
  needs: ["build", "cucumber"]  # ✅ seulement les tests obligatoires ❌ ne dépend pas de newman
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  script:
    - ./scripts/deploy-dev.sh

# Deploy QA
deploy_qa:
  stage: deploy
  needs: ["build", "cucumber", "newman"]  # ✅ dépend obligatoirement des tous les tests
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - ./scripts/deploy-qa.sh

# Release
release:
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  script:
    - mvn versions:set -DnewVersion=$(date +%Y.%m.%d)
    - git tag v$(date +%Y.%m.%d)
    - git push origin --tags

# Maintenance
maintenance:
  stage: maintenance
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - ./scripts/cleanup.sh